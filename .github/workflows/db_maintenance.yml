name: Database Maintenance

on:
  schedule:
    - cron: "0 2 1 * *" # ë§¤ì›” 1ì¼ ì˜¤ì „ 2ì‹œ (UTC)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰
    inputs:
      archive_months:
        description: "ì•„ì¹´ì´ë¹™í•  ê°œì›” ìˆ˜"
        required: false
        default: "6"
      cleanup_months:
        description: "ì‚­ì œí•  ê°œì›” ìˆ˜"
        required: false
        default: "6"

jobs:
  maintenance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install supabase

      - name: Check initial capacity
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "=== ì´ˆê¸° ìš©ëŸ‰ í™•ì¸ ==="
          python scripts/check_db_capacity.py

      - name: Archive old posts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          ARCHIVE_MONTHS: ${{ github.event.inputs.archive_months || '6' }}
        run: |
          echo "=== ì•„ì¹´ì´ë¹™ ì‹œìž‘ ==="
          python scripts/archive_old_posts.py

      - name: Upload archives
        uses: actions/upload-artifact@v3
        with:
          name: database-archives-${{ github.run_number }}
          path: archives/*.csv
          retention-days: 90

      - name: Cleanup old posts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          CLEANUP_MONTHS: ${{ github.event.inputs.cleanup_months || '6' }}
        run: |
          echo "=== ë°ì´í„° ì •ë¦¬ ì‹œìž‘ ==="
          python scripts/cleanup_old_posts.py

      - name: Check final capacity
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "=== ìµœì¢… ìš©ëŸ‰ í™•ì¸ ==="
          python scripts/check_db_capacity.py

      - name: Create summary
        run: |
          echo "## ë°ì´í„°ë² ì´ìŠ¤ ìœ ì§€ë³´ìˆ˜ ì™„ë£Œ ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ì•„ì¹´ì´ë¸Œ íŒŒì¼ì´ Artifactsì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          echo "- ë³´ê´€ ê¸°ê°„: 90ì¼" >> $GITHUB_STEP_SUMMARY
          echo "- ì‹¤í–‰ ì‹œê°„: $(date)" >> $GITHUB_STEP_SUMMARY
